<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Combining data with bayesdfa • bayesdfa</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Combining data with bayesdfa">
<meta property="og:description" content="bayesdfa">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bayesdfa</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.3.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a1_bayesdfa.html">Overview of the bayesdfa package</a>
    </li>
    <li>
      <a href="../articles/a2_combining_data.html">Combining data with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/a3_covariates.html">Examples of including covariates with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/a4_smooth.html">Examples of fitting smooth trend DFA models</a>
    </li>
    <li>
      <a href="../articles/a5_estimate_process_sigma.html">Estimating process trend variability with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/a6_compositional.html">Fitting compositional dynamic factor models with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/a7_bigdata.html">Examples of fitting DFA models with lots of data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/fate-ewi/bayesdfa/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Combining data with bayesdfa</h1>
                        <h4 data-toc-skip class="author">Eric J. Ward,
Sean C. Anderson, Mary E. Hunsicker, Mike A. Litzow, Luis A. Damiano,
Mark D. Scheuerell, Elizabeth E. Holmes, Nick Tolimieri</h4>
            
            <h4 data-toc-skip class="date">2024-10-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/fate-ewi/bayesdfa/blob/HEAD/vignettes/a2_combining_data.Rmd" class="external-link"><code>vignettes/a2_combining_data.Rmd</code></a></small>
      <div class="hidden name"><code>a2_combining_data.Rmd</code></div>

    </div>

    
    
<p>For some applications using DFA, datasets may need to be combined
from several data sources, and they may differ in time series length (or
precision). Here we’ll use some simple examples using
<code><a href="../reference/fit_dfa.html">fit_dfa()</a></code> and to illustrate some cautionary points.</p>
<p>Let’s load the necessary packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fate-ewi.github.io/bayesdfa/" class="external-link">bayesdfa</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span></span>
<span><span class="va">chains</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">iter</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="co">#library(viridis)</span></span></code></pre></div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>First, let’s simulate some simple data with <code><a href="../reference/sim_dfa.html">sim_dfa()</a></code>.
First, using just a 1 - trend model. This example has 3 time series, and
is simulated from 1 underlying trend. The first time series doesn’t load
heavily on the trend (it’s mostly generated via white noise) but time
series 2-3 have stronger loadings on the trend.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">loadings</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">loadings</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">loadings</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0.4</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">loadings</span>,<span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       [,1]</span></span>
<span><span class="co">## [1,] 0.100</span></span>
<span><span class="co">## [2,] 0.573</span></span>
<span><span class="co">## [3,] 0.873</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_dfa.html">sim_dfa</a></span><span class="op">(</span>num_trends <span class="op">=</span> <span class="fl">1</span>, num_years <span class="op">=</span> <span class="fl">100</span>, </span>
<span>  num_ts <span class="op">=</span> <span class="fl">3</span>, loadings_matrix <span class="op">=</span> <span class="va">loadings</span>, </span>
<span>  sigma<span class="op">=</span><span class="fl">0.6</span><span class="op">)</span></span></code></pre></div>
<p>Here we can see that time series 1 is more variable because the
random component is playing a relatively larger role.</p>
<p><img src="a2_combining_data_files/figure-html/unnamed-chunk-3-1.png" width="528"></p>
<p><img src="a2_combining_data_files/figure-html/unnamed-chunk-4-1.png" width="528"></p>
<p>Let’s initially treat the first ~ 50 time points as a burn in, and
fit a DFA model to the latter half of the time series, using all data.
We don’t really have to rotate trends (because there’s just 1). The
loadings are estimated ok for trend 1, but underestimated for the
others.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_1</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">y_sim</span><span class="op">[</span>,<span class="fl">51</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span>, num_trends <span class="op">=</span> <span class="fl">1</span>, chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: There were 5 divergent transitions after warmup. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">## to find out why this is a problem and how to eliminate them.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre>
<pre><code><span><span class="co">## Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">## Running the chains for more iterations may help. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#r-hat</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="../reference/rotate_trends.html">rotate_trends</a></span><span class="op">(</span><span class="va">fit_1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">Z_rot_mean</span>,<span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         1</span></span>
<span><span class="co">## 1 -98.567</span></span>
<span><span class="co">## 2 -15.488</span></span>
<span><span class="co">## 3  19.395</span></span></code></pre>
<p>Now, we’ll pretend that in time steps 1:50 we have observations from
time series 1 (but not the others). We’ll fit several additional models,
adding in back data points in steps of 10, and going backwards in time.
All these runs would use time points 51:100 for time series 2 and 3, but
they would include time steps 51:100, then 41:100, 31:100, etc. for time
series 1.</p>
<p><em>Note for comparison purposes, we’ll also standardize all time
series 1 time before passing them in as an argument. Time series # 1
won’t be re-scaled, but will be re-centered for each iteration. This is
important because the time-series are non-stationary.</em></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="st">"ts_start"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">25</span>,<span class="fl">50</span><span class="op">)</span>, </span>
<span>  <span class="st">"x"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="st">"estimated_trend"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"obs"</span><span class="op">=</span><span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">idx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">26</span>,<span class="fl">51</span><span class="op">)</span> <span class="co"># seq(1,60,10)[nrow(l)+1-i]</span></span>
<span>  <span class="va">Y</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">y_sim</span></span>
<span>  <span class="va">Y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">Y</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">idx</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="va">Y</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="va">fit_2</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Y</span>, num_trends <span class="op">=</span> <span class="fl">1</span>, chains<span class="op">=</span><span class="fl">1</span>, iter<span class="op">=</span><span class="fl">10</span>, scale<span class="op">=</span><span class="st">"center"</span><span class="op">)</span></span>
<span>  <span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="../reference/rotate_trends.html">rotate_trends</a></span><span class="op">(</span><span class="va">fit_2</span><span class="op">)</span></span>
<span>  <span class="va">l</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">Z_rot_mean</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">estimated_trend</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">ts_start</span><span class="op">==</span><span class="op">(</span><span class="va">idx</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">Z_rot_mean</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">r</span><span class="op">$</span><span class="va">trends_mean</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">obs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">ts_start</span><span class="op">==</span><span class="op">(</span><span class="va">idx</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="va">Y</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">51</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we can look at the effects of adding in the extra data from time
series 2. Here are the predictions for time series 2 over time steps
51:100, adding more data in from time series 1. What this shows is that
in general the trends are the same – though there are nuanced
differences between them.</p>
<p><img src="a2_combining_data_files/figure-html/unnamed-chunk-8-1.png" width="528"></p>
<p>As a cautionary note, any time time series of different lenghts are
combined using similar approaches, simulations should be done to try to
estimate the influence of adding new data to shared trends or other
quantities of interest.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Eric J. Ward, Sean C. Anderson, Luis A. Damiano, Michael J. Malick, Philina A. English.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
