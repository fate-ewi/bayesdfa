<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overview of the bayesdfa package • bayesdfa</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Overview of the bayesdfa package">
<meta property="og:description" content="bayesdfa">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bayesdfa</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.3.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a1_bayesdfa.html">Overview of the bayesdfa package</a>
    </li>
    <li>
      <a href="../articles/a2_combining_data.html">Combining data with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/a3_covariates.html">Examples of including covariates with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/a4_smooth.html">Examples of fitting smooth trend DFA models</a>
    </li>
    <li>
      <a href="../articles/a5_estimate_process_sigma.html">Estimating process trend variability with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/a6_compositional.html">Fitting compositional dynamic factor models with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/a7_bigdata.html">Examples of fitting DFA models with lots of data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/fate-ewi/bayesdfa/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Overview of the bayesdfa package</h1>
                        <h4 data-toc-skip class="author">Eric J. Ward,
Sean C. Anderson, Mary E. Hunsicker, Mike A. Litzow, Luis A. Damiano,
Mark D. Scheuerell, Elizabeth E. Holmes, Nick Tolimieri</h4>
            
            <h4 data-toc-skip class="date">2024-02-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/fate-ewi/bayesdfa/blob/HEAD/vignettes/a1_bayesdfa.Rmd" class="external-link"><code>vignettes/a1_bayesdfa.Rmd</code></a></small>
      <div class="hidden name"><code>a1_bayesdfa.Rmd</code></div>

    </div>

    
    
<p>Here we will use the bayesdfa package to fit dynamic factor analysis
(DFA) model to simulated time series data. In addition to working
through an example of DFA for multivariate time series, we’ll apply
bayesdfa routines for fitting hidden Markov models (HMMs) to the
estimated trends to identify latent regimes. Most of the core functions
of the package are included here, including <code><a href="../reference/fit_dfa.html">fit_dfa()</a></code> and
<code>find_dfa_trends</code> for fitting DFA models,
<code><a href="../reference/plot_trends.html">plot_trends()</a></code>, <code><a href="../reference/plot_fitted.html">plot_fitted()</a></code> and
<code><a href="../reference/plot_loadings.html">plot_loadings()</a></code> for plotting estimates,
<code><a href="../reference/find_swans.html">find_swans()</a></code> for flagging extremes,
<code><a href="../reference/fit_regimes.html">fit_regimes()</a></code> and <code><a href="../reference/find_regimes.html">find_regimes()</a></code> for fitting
HMM models, and <code>plot_regimes()</code> for plotting HMM output.</p>
<p>Let’s load the necessary packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fate-ewi.github.io/bayesdfa/" class="external-link">bayesdfa</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span></span>
<span><span class="va">chains</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">iter</span> <span class="op">=</span> <span class="fl">10</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction-to-the-dfa-model">Introduction to the DFA model<a class="anchor" aria-label="anchor" href="#introduction-to-the-dfa-model"></a>
</h2>
<p>We adopt the same notation used in the MARSS package for dynamic
factor analysis models. The DFA model consists of two models, one
describing the latent process or states, and an observation or data
model linking the process model to observations. Slight variations on
this model are described below, but the process model for the basic DFA
model is written as a multivariate random walk,</p>
<p><span class="math display">\[\textbf{x}_{t+1}= \textbf{x}_{t} +
\textbf{w}_{t}\]</span> where the matrix <span class="math inline">\(\textbf{x}\)</span> is dimensioned as the number
of years <span class="math inline">\(N\)</span> by the number of latent
trends <span class="math inline">\(K\)</span>. The process error is
assumed to be multivariate normal, <span class="math inline">\(\textbf{w}_{t} \sim MVN(0,\textbf{Q})\)</span>
where <span class="math inline">\(\textbf{Q}\)</span> is generally
assumed to be a <span class="math inline">\(K\)</span>-by-<span class="math inline">\(K\)</span> identity matrix.</p>
<p>The observation or data model linking <span class="math inline">\(\textbf{x}_{t}\)</span> to observed data <span class="math inline">\(\textbf{y}_{t}\)</span> is</p>
<p><span class="math display">\[\textbf{y}_{t} = \textbf{Zx}_{t} +
\textbf{B}\textbf{d}_{t} + \textbf{e}_{t}\]</span> The matrix <span class="math inline">\(Z\)</span> represents a matrix of estimated
loadings, dimensioned as number of time series <span class="math inline">\(P\)</span> by number of latent trends <span class="math inline">\(K\)</span>. Optional covariates <span class="math inline">\(\textbf{d}_{t}\)</span> are included in the
observation model with estimated coefficients <span class="math inline">\(B\)</span>. The residual errors <span class="math inline">\(\textbf{e}_{t}\)</span> are assumed to be normally
distributed, e.g. <span class="math inline">\(\textbf{e}_{t} \sim MVN(0,
\textbf{R})\)</span>. There are a number of choices for <span class="math inline">\(\textbf{R}\)</span> – these can be a diagonal
matrix with equal or unequal elements, or an unconstrained covariance
matrix.</p>
</div>
<div class="section level2">
<h2 id="dfa-model-with-no-extreme-events">DFA model with no extreme events<a class="anchor" aria-label="anchor" href="#dfa-model-with-no-extreme-events"></a>
</h2>
<p>First, let’s simulate some data. We will use the built-in function
<code><a href="../reference/sim_dfa.html">sim_dfa()</a></code>, but normally you would start with your own data.
We will simulate 20 data points from 4 time series, generated from 2
latent processes. For this first dataset, the data won’t include
extremes, and loadings will be randomly assigned (default).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">sim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_dfa.html">sim_dfa</a></span><span class="op">(</span></span>
<span>  num_trends <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  num_years <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  num_ts <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="a1_bayesdfa_files/figure-html/simulate-data-plot-1.png" alt="Simulated data, from a model with 2 latent trends and no extremes.\label{fig:simulate-data-plot}" width="528"><p class="caption">
Simulated data, from a model with 2 latent trends and no extremes.
</p>
</div>
<p>Next, we’ll fit a 1-trend, 2-trend, and 3-trend DFA model to the
simulated time series using the <code><a href="../reference/fit_dfa.html">fit_dfa()</a></code> function.
Starting with the 1-trend model, we’ll estimate the posterior
distributions of the trends and loadings. Note that this example uses 1
MCMC chain and 50 iterations — for real examples, you’ll want to use
more (say 4 chains, 5000 iterations).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">y_sim</span>, num_trends <span class="op">=</span> <span class="fl">1</span>, scale<span class="op">=</span><span class="st">"zscore"</span>,</span>
<span>  iter <span class="op">=</span> <span class="va">iter</span>, chains <span class="op">=</span> <span class="va">chains</span>, thin <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Convergence of DFA models can be evaluated with our
<code><a href="../reference/is_converged.html">is_converged()</a></code> function. This function takes a fitted
object, and specified <code>threshold</code> argument representing the
maximum allowed Rhat value (default = 1.05). The convergence test isn’t
that useful for a model with such a short number of iterations, but is
called with</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is_converged.html">is_converged</a></span><span class="op">(</span><span class="va">f1</span>, threshold <span class="op">=</span> <span class="fl">1.05</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>This function evaluates Rhat values for all parameters and log
likelihood values - so be sure to check what’s not converging if the
model is not passing this test.</p>
<p>Before we extract the trends from the model, we need to rotate the
loadings matrix and trends. By default we use the varimax rotation,
implemented in the <code><a href="../reference/rotate_trends.html">rotate_trends()</a></code> function. An optional
argument is the <code>conf_level</code> argument, which calculates the
specified confidence (credible) interval of the estimates (by default,
this is set to 0.95).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rotate_trends.html">rotate_trends</a></span><span class="op">(</span><span class="va">f1</span><span class="op">)</span></span></code></pre></div>
<p>The rotated object has several quantities of interest, including the
mean values of the trends “trends_mean” and loadings “Z_rot_mean”,</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Z_rot"         "trends"        "Z_rot_mean"    "Z_rot_median" </span></span>
<span><span class="co">## [5] "trends_mean"   "trends_median" "trends_lower"  "trends_upper"</span></span></code></pre>
<p>We can then plot the trends and intervals, with</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_trends.html">plot_trends</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="a1_bayesdfa_files/figure-html/plot-1-trend-1.png" alt="Estimated trend and 95% CI for a 1-trend DFA model applied to simulated data.\label{fig:simulate-data-plot}" width="528"><p class="caption">
Estimated trend and 95% CI for a 1-trend DFA model applied to simulated
data.
</p>
</div>
<p>We can also plot the estimated loadings (we’ll show that plot for the
more complicated 2-trend model below because it’s not as interesting for
the 1-trend model) and the fitted values. To plot the fitted values from
the 1-trend model, we’ll use the <code><a href="../reference/plot_fitted.html">plot_fitted()</a></code> function
(predicted values can also be returned without a plot, with the
<code><a href="../reference/predicted.html">predicted()</a></code>) function.</p>
<p>The trends and intervals are plotted, faceting by time series,
with</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_fitted.html">plot_fitted</a></span><span class="op">(</span><span class="va">f1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="a1_bayesdfa_files/figure-html/plot-1-fitted-example-1.png" alt="Model predicted values from the 1-trend DFA model applied to simulated data.\label{fig:fitted-example}" width="528"><p class="caption">
Model predicted values from the 1-trend DFA model applied to simulated
data.
</p>
</div>
<p>Moving to a more complex model, we’ll fit the 2-trend and 3-trend
models. All other arguments stay the same as before,</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">y_sim</span>, num_trends <span class="op">=</span> <span class="fl">2</span>, scale<span class="op">=</span><span class="st">"zscore"</span>,</span>
<span>  iter <span class="op">=</span> <span class="va">iter</span>, chains <span class="op">=</span> <span class="va">chains</span>, thin <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rotate_trends.html">rotate_trends</a></span><span class="op">(</span><span class="va">f2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">y_sim</span>, num_trends <span class="op">=</span> <span class="fl">3</span>, scale<span class="op">=</span><span class="st">"zscore"</span>,</span>
<span>  iter <span class="op">=</span> <span class="va">chains</span>, chains <span class="op">=</span> <span class="va">chains</span>, thin <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">r3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rotate_trends.html">rotate_trends</a></span><span class="op">(</span><span class="va">f3</span><span class="op">)</span></span></code></pre></div>
<p>The fits from the 2-trend model look considerably better than that
from the 1-trend model,</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_fitted.html">plot_fitted</a></span><span class="op">(</span><span class="va">f2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="a1_bayesdfa_files/figure-html/plot-2-fitted-example-1.png" alt="Model predicted values from the 2-trend DFA model applied to simulated data.\label{fig:fitted-example2}" width="528"><p class="caption">
Model predicted values from the 2-trend DFA model applied to simulated
data.
</p>
</div>
<p>The loadings from the 1-trend model aren’t as interesting because for
a 1-trend model the loadings are a 1-dimensional vector. For the 2 trend
model, there’s a separate loading of each time series on each trend,</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">r2</span><span class="op">$</span><span class="va">Z_rot_mean</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        [,1]    [,2]</span></span>
<span><span class="co">## [1,] -90.54  -41.89</span></span>
<span><span class="co">## [2,] -19.10 -117.64</span></span>
<span><span class="co">## [3,]  -7.55   58.95</span></span>
<span><span class="co">## [4,] -49.06   15.14</span></span></code></pre>
<p>These loadings can also be plotted with the
<code><a href="../reference/plot_loadings.html">plot_loadings()</a></code> function. This shows the distribution of
the densities as violin plots, with color proportional to being
different from 0.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_loadings.html">plot_loadings</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="a1_bayesdfa_files/figure-html/plot-loadings-1.png" alt="Estimated loadings from the 2-trend DFA model.\label{fig:plot-loadings}" width="528"><p class="caption">
Estimated loadings from the 2-trend DFA model.
</p>
</div>
<p>Finally, we might be interested in comparing some measure of model
selection across these models to identify whether the data support the
1-trend, 2-trend, or 3-trend models. The Leave One Out Information
Criterion can be calculated with the <code><a href="../reference/loo.html">loo()</a></code> function, for
example the LOOIC for the 1-trend model can be accessed with</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">f1</span><span class="op">)</span></span>
<span><span class="va">loo1</span><span class="op">$</span><span class="va">estimates</span></span></code></pre></div>
<pre><code><span><span class="co">##               Estimate           SE</span></span>
<span><span class="co">## elpd_loo -2.973137e+04 6.859515e+03</span></span>
<span><span class="co">## p_loo     8.881784e-16 1.919552e-15</span></span>
<span><span class="co">## looic     5.946275e+04 1.371903e+04</span></span></code></pre>
<p>where 5.9462745^{4} is the estimate and 1.371903^{4} is the standard
error.</p>
<p>As an alternative to fitting each model individually as we did above,
we also developed the <code><a href="../reference/find_dfa_trends.html">find_dfa_trends()</a></code> to automate fitting
a larger number of models. In addition to evaluating different trends,
this function allows the user to optionally evaluate models with normal
and Student-t process errors, and alternative variance structures
(observation variance of time series being equal, or not). For example,
to fit models with 1:5 trends, both Student-t and normal errors, and
equal and unequal variances, the call would be</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_dfa_trends.html">find_dfa_trends</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">y_sim</span>, iter <span class="op">=</span> <span class="va">iter</span>,</span>
<span>  kmin <span class="op">=</span> <span class="fl">1</span>, kmax <span class="op">=</span> <span class="fl">5</span>, chains <span class="op">=</span> <span class="va">chains</span>, compare_normal <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  variance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"equal"</span>, <span class="st">"unequal"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="dfa-model-with-extreme-events">DFA model with extreme events<a class="anchor" aria-label="anchor" href="#dfa-model-with-extreme-events"></a>
</h2>
<p>In this example, we’ll simulate data with an extreme anomaly. The
biggest difference between this model and the conventional model is that
in the DFA process model,</p>
<p><span class="math display">\[\textbf{x}_{t+1}= \textbf{x}_{t} +
\textbf{w}_{t}\]</span></p>
<p>instead of <span class="math inline">\(\textbf{w}_{t}\)</span> being
normally distributed, we assume <span class="math inline">\(\textbf{w}_{t}\)</span> is Student-t distributed.
With multiple trends, this becomes a multivariate Student-t,</p>
<p><span class="math display">\[\textbf{w}_{t} \sim MVT(\nu, 0,
\textbf{Q})\]</span> The parameter <span class="math inline">\(\nu\)</span> controls how much the tails of this
distribution deviate from the normal, with smaller values (<span class="math inline">\(\nu\)</span> closer to 2) resulting in more
extreme anomalies, and large values (<span class="math inline">\(\nu\)</span> closer to 30) resulting in behavior
similar to a normal distribution.</p>
<p>As before, this will be 20 data points from 4 time series, generated
from 2 latent processes. The <code><a href="../reference/sim_dfa.html">sim_dfa()</a></code> function’s arguments
<code>extreme_value</code> and <code>extreme_loc</code> allow the user
to specify the magnitude of the extreme (as an additive term in the
random walk), and the location of the extreme (defaults to the midpoint
of the time series). Here we’ll include an extreme value of 6,</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">sim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_dfa.html">sim_dfa</a></span><span class="op">(</span></span>
<span>  num_trends <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  num_years <span class="op">=</span> <span class="fl">20</span>, num_ts <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  extreme_value <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Plotting the data shows the anomaly occurring between time step 9 and
10,</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim_dat</span><span class="op">$</span><span class="va">y_sim</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylab <span class="op">=</span> <span class="st">"Response"</span>, xlab <span class="op">=</span> <span class="st">"Time"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="a1_bayesdfa_files/figure-html/simulate-data-plot2-1.png" alt="Simulated data, from a model with 2 latent trends and an extreme in the midpoint of the time series.\label{fig:simulate-data-plot2}" width="528"><p class="caption">
Simulated data, from a model with 2 latent trends and an extreme in the
midpoint of the time series.
</p>
</div>
<p>Though the plot is a little more clear if we standardize the time
series first,</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim_dat</span><span class="op">$</span><span class="va">y_sim</span><span class="op">)</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylab <span class="op">=</span> <span class="st">"Response"</span>, xlab <span class="op">=</span> <span class="st">"Time"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="a1_bayesdfa_files/figure-html/simulate-data-plot3-1.png" alt="Simulated data (z-scored), from a model with 2 latent trends and an extreme in the midpoint of the time series.\label{fig:simulate-data-plot3}" width="528"><p class="caption">
Simulated data (z-scored), from a model with 2 latent trends and an
extreme in the midpoint of the time series.
</p>
</div>
<p>Instead of fitting a model with normal process deviations, we may be
interested in fitting the model with Student-t deviations. We can turn
on the estimation of <code>nu</code> with the <code>estimate_nu</code>
argument. [Alternatively, nu can also be fixed a priori by setting the
argument <code>nu_fixed</code>]. Here’s the code for a 2-trend model
with Student-t deviations,</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">y_sim</span>, num_trends <span class="op">=</span> <span class="fl">2</span>, scale<span class="op">=</span><span class="st">"zscore"</span>,</span>
<span>  iter <span class="op">=</span> <span class="va">iter</span>, chains <span class="op">=</span> <span class="va">chains</span>, thin <span class="op">=</span> <span class="fl">1</span>, estimate_nu <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Again we have to rotate the trends before plotting,</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rotate_trends.html">rotate_trends</a></span><span class="op">(</span><span class="va">t2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_trends.html">plot_trends</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="a1_bayesdfa_files/figure-html/fit-extreme-dfa-1.png" alt="Estimated trends, from a model with 2 latent trends Student-t deviations.\label{fig:fit-extreme-dfa}" width="528"><p class="caption">
Estimated trends, from a model with 2 latent trends Student-t
deviations.
</p>
</div>
<p>And the loadings,</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_loadings.html">plot_loadings</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="a1_bayesdfa_files/figure-html/plot-extreme-loadings-1.png" alt="Estimated loadings, from a model with 2 latent trends Student-t deviations.\label{fig:plot-extreme-loadings}" width="528"><p class="caption">
Estimated loadings, from a model with 2 latent trends Student-t
deviations.
</p>
</div>
<p>One way to look for extremes is using the <code><a href="../reference/find_swans.html">find_swans()</a></code>
function, which evaluates the probability of observing a deviation in
the estimated trend (or data) greater than what is expected from a
normal distribution. This function takes a <code>threshold</code>
argument, which specifies the cutoff. For example, to find extremes
greater than 1 in 1000 under a normal distribution, the function call
is</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/find_swans.html">find_swans</a></span><span class="op">(</span><span class="va">r</span>, plot <span class="op">=</span> <span class="cn">FALSE</span>, threshold <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p>Setting plot to TRUE also creates a time series plot that flags these
values.</p>
<p>We can also look at the estimated <code>nu</code> parameter, which
shows some support for using the Student-t distribution (values greater
than ~ 30 lead to similar behavior as a normal distribution),</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">t2</span><span class="op">$</span><span class="va">model</span>, <span class="st">"nu"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        V1      </span></span>
<span><span class="co">##  Min.   :2.82  </span></span>
<span><span class="co">##  1st Qu.:2.82  </span></span>
<span><span class="co">##  Median :2.82  </span></span>
<span><span class="co">##  Mean   :2.82  </span></span>
<span><span class="co">##  3rd Qu.:2.82  </span></span>
<span><span class="co">##  Max.   :2.82</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="fitting-dfa-models-with-non-gaussian-families">Fitting DFA models with non-Gaussian families<a class="anchor" aria-label="anchor" href="#fitting-dfa-models-with-non-gaussian-families"></a>
</h2>
<p>We’ve implemented a number of alternative families for cases when the
response variable might be non-normally distributed. These alternative
families may be specified with the family argument as a text string in
the <code>fit_dfa</code> function, e.g.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span><span class="va">...</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span></code></pre></div>
<p>The currently supported families can be specified as any of the
following – the link functions are currently hard-coded, and included in
the table below.</p>
<table class="table">
<thead><tr class="header">
<th align="left">Family</th>
<th align="left">link</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">gaussian</td>
<td align="left">identity</td>
</tr>
<tr class="even">
<td align="left">lognormal</td>
<td align="left">log</td>
</tr>
<tr class="odd">
<td align="left">gamma</td>
<td align="left">log</td>
</tr>
<tr class="even">
<td align="left">binomial</td>
<td align="left">logit</td>
</tr>
<tr class="odd">
<td align="left">poisson</td>
<td align="left">log</td>
</tr>
<tr class="even">
<td align="left">nbinom2</td>
<td align="left">log</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="alternative-loadings-for-dfa-models">Alternative loadings for DFA models<a class="anchor" aria-label="anchor" href="#alternative-loadings-for-dfa-models"></a>
</h2>
<p>By default, the loadings matrix in a DFA is constrained by zeros. For
example, a 3-trend model applied to 5 time series would have a loadings
matrix that was constrained as</p>
<table class="table">
<thead><tr class="header">
<th align="left">Trend 1</th>
<th align="left">Trend 2</th>
<th align="left">Trend 3</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">z[1,1]</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">z[2,1]</td>
<td align="left">z[2,2]</td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left">z[3,1]</td>
<td align="left">z[3,2]</td>
<td align="left">z[3,3]</td>
</tr>
<tr class="even">
<td align="left">z[4,1]</td>
<td align="left">z[4,2]</td>
<td align="left">z[4,3]</td>
</tr>
<tr class="odd">
<td align="left">z[5,1]</td>
<td align="left">z[5,2]</td>
<td align="left">z[5,3]</td>
</tr>
</tbody>
</table>
<p>As an alternative, we may wish to fit a model where each time series
arises as a mixture of the trends. In this case, the loadings matrix
would be</p>
<table class="table">
<thead><tr class="header">
<th align="left">Trend 1</th>
<th align="left">Trend 2</th>
<th align="left">Trend 3</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">z[1,1]</td>
<td align="left">z[1,2]</td>
<td align="left">z[1,3]</td>
</tr>
<tr class="even">
<td align="left">z[2,1]</td>
<td align="left">z[2,2]</td>
<td align="left">z[2,3]</td>
</tr>
<tr class="odd">
<td align="left">z[3,1]</td>
<td align="left">z[3,2]</td>
<td align="left">z[3,3]</td>
</tr>
<tr class="even">
<td align="left">z[4,1]</td>
<td align="left">z[4,2]</td>
<td align="left">z[4,3]</td>
</tr>
<tr class="odd">
<td align="left">z[5,1]</td>
<td align="left">z[5,2]</td>
<td align="left">z[5,3]</td>
</tr>
</tbody>
</table>
<p>And the added constraint is that each row sums to 1, e.g.</p>
<p><span class="math display">\[\sum_{j=1:3} Z_{1,j} = 1\]</span> ##
Including autoregressive (AR) or moving-average (MA) components on
trends</p>
<p>For some models, it may be appropriate to include autoregressive or
moving average components to model the latent trends. We’ve implemented
1st - order components on each, though by default these are not
included.</p>
<p>To include the AR(1) component on the trend, you can specify</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span><span class="va">...</span>, estimate_trend_ar <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This results in a model where trend <span class="math inline">\(i\)</span> is modeled as</p>
<p><span class="math display">\[x_{i,t+1} = \phi_{i}*x_{i,t} +
\delta_{i,t}\]</span> Each trend is allowed to have a unique AR(1)
parameter, <span class="math inline">\(\phi_{i}\)</span>.</p>
<p>In conventional DFA models, the process deviations are assumed to be
independent, e.g. <span class="math inline">\(\delta_{i,t} ~ Normal(0,
r)\)</span>. By including a MA(1) component on the trends, these terms
may be modeled as</p>
<p><span class="math display">\[delta_{i,t+1} \sim Normal(
\theta_{i}*delta_{i,t}, q_{i})\]</span></p>
<p>where <span class="math inline">\(\theta_{i}\)</span> is the
trend-specific MA parameter, <span class="math inline">\(q\)</span> is
the process variance, and usually constrained to be not estimated and
fixed at 1.</p>
</div>
<div class="section level2">
<h2 id="applying-hidden-markov-models-to-identify-latent-regimes">Applying Hidden Markov Models to identify latent regimes<a class="anchor" aria-label="anchor" href="#applying-hidden-markov-models-to-identify-latent-regimes"></a>
</h2>
<p>Finally, we might be interested in evaluating evidence for the
estimated trends changing between multiple regimes. We’ve implemented
HMMs in the functions <code><a href="../reference/fit_regimes.html">fit_regimes()</a></code> and
<code><a href="../reference/find_regimes.html">find_regimes()</a></code>. <code>fit_regimes</code> fits a HMM with a
pre-specified number of latent states, while <code><a href="../reference/find_regimes.html">find_regimes()</a></code>
loops over a range of models so that support can be evaluated with
LOOIC.</p>
<p>We’ll illustrate an example of the <code><a href="../reference/fit_regimes.html">fit_regimes()</a></code>
function. Note that in the current version of the package, this has to
be applied to each trend separately. Also, uncertainty estimates from
the DFA trends may also be included as data (instead of estimated) –
this may be particularly useful for datasets with lots of missing values
in portions of the time series (where the uncertainty balloons up).</p>
<p>Applying the 2-regime model to the first trend,</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_regimes.html">fit_regimes</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">trends_mean</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>,</span>
<span>  sds <span class="op">=</span> <span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">trends_upper</span> <span class="op">-</span> <span class="va">r</span><span class="op">$</span><span class="va">trends_mean</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">/</span> <span class="fl">1.96</span>,</span>
<span>  n_regimes <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">50</span>, chains <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In addition to getting diagnostics and quantities like LOOIC out of
the <code>reg_mod</code> object, we can plot the estimated states.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_regime_model.html">plot_regime_model</a></span><span class="op">(</span><span class="va">reg_mod</span><span class="op">)</span></span></code></pre></div>
<p>In this case, there might be some support for the 2-regime model.
Sometimes (but not in this example) label switching makes the plots a
little challenging to interpret, and the labels need to be reversed.
We’ve included the argument <code>flip_regimes</code> to help with
this,</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_regime_model.html">plot_regime_model</a></span><span class="op">(</span><span class="va">reg_mod</span>, flip_regimes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="dfa-model-with-weights">DFA model with weights<a class="anchor" aria-label="anchor" href="#dfa-model-with-weights"></a>
</h2>
<p>We allow weights to be used in DFA models in two ways. In the first
form, inverse variance weighting is used to adjust observations based on
some standard error associated with each observation. Specifically, the
weights are included by modifying each variance to be <span class="math display">\[\sigma^2 / w_i\]</span>. As a concrete example,
we’ll simulate a dataset, add some examples of standard errors on the
survey indices, and then perform the DFA.</p>
<p>Our simulated standard errors are the same for all surveys – except
time series 2, which is much more precise.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">sim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_dfa.html">sim_dfa</a></span><span class="op">(</span></span>
<span>  num_trends <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  num_years <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  num_ts <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_dat</span><span class="op">$</span><span class="va">y_sim</span><span class="op">)</span>, time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 ts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">se</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">ts</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0.2</span></span></code></pre></div>
<p>Next we can generate the weights (this is redundant, and “se” could
be used instead in the function call below). Because the weights are
used as an offset, <span class="math display">\[\sigma^2 / w_i\]</span>,
we don’t want to use the SE alone as a weight but make them inversely
related to the SE. As a quick note, the scale of these may affect
estimation and some additional normalization may be needed (rather than
standard errors, it may be more helpful to think about the sample size
each data point represents).</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">df</span><span class="op">$</span><span class="va">se</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span></code></pre></div>
<p>And fit the model with the weights argument</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">df</span>, num_trends <span class="op">=</span> <span class="fl">2</span>, scale<span class="op">=</span><span class="st">"zscore"</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">500</span>, chains <span class="op">=</span> <span class="fl">1</span>, thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  inv_var_weights <span class="op">=</span> <span class="st">"weights"</span>, data_shape <span class="op">=</span> <span class="st">"long"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## SAMPLING FOR MODEL 'dfa' NOW (CHAIN 1).</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1: Gradient evaluation took 4.7e-05 seconds</span></span>
<span><span class="co">## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.47 seconds.</span></span>
<span><span class="co">## Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1: Iteration:   1 / 500 [  0%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration:  50 / 500 [ 10%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration: 100 / 500 [ 20%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration: 150 / 500 [ 30%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration: 200 / 500 [ 40%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration: 250 / 500 [ 50%]  (Warmup)</span></span>
<span><span class="co">## Chain 1: Iteration: 251 / 500 [ 50%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 300 / 500 [ 60%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 350 / 500 [ 70%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 400 / 500 [ 80%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 450 / 500 [ 90%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: Iteration: 500 / 500 [100%]  (Sampling)</span></span>
<span><span class="co">## Chain 1: </span></span>
<span><span class="co">## Chain 1:  Elapsed Time: 24.43 seconds (Warm-up)</span></span>
<span><span class="co">## Chain 1:                4.508 seconds (Sampling)</span></span>
<span><span class="co">## Chain 1:                28.938 seconds (Total)</span></span>
<span><span class="co">## Chain 1:</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">## Running the chains for more iterations may help. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#bulk-ess</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">## Running the chains for more iterations may help. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre>
<pre><code><span><span class="co">## Inference for the input samples (1 chains: each with iter = 250; warmup = 125):</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                Q5  Q50  Q95 Mean  SD  Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## x[1,1]       -0.9 -0.4  0.0 -0.4 0.3  1.02      149      106</span></span>
<span><span class="co">## x[2,1]        1.4  1.9  2.6  2.0 0.4  1.04       42       43</span></span>
<span><span class="co">## x[1,2]       -1.6 -1.1 -0.7 -1.1 0.3  1.00       67       71</span></span>
<span><span class="co">## x[2,2]        1.4  2.2  3.0  2.2 0.5  1.05       46      108</span></span>
<span><span class="co">## x[1,3]        0.1  0.5  0.9  0.5 0.3  1.00       96       84</span></span>
<span><span class="co">## x[2,3]        0.7  1.1  1.6  1.2 0.3  1.02       30       59</span></span>
<span><span class="co">## x[1,4]        1.0  1.6  2.2  1.6 0.4  0.99       70       85</span></span>
<span><span class="co">## x[2,4]        0.5  1.3  2.0  1.3 0.5  1.04       23       12</span></span>
<span><span class="co">## x[1,5]        0.0  0.4  1.0  0.4 0.3  0.99      111      106</span></span>
<span><span class="co">## x[2,5]        0.4  0.8  1.2  0.8 0.3  1.03       30       35</span></span>
<span><span class="co">## x[1,6]        0.8  1.3  2.0  1.4 0.4  1.01       63       42</span></span>
<span><span class="co">## x[2,6]        0.2  0.9  1.4  0.9 0.4  1.08       20       11</span></span>
<span><span class="co">## x[1,7]        0.3  0.6  1.2  0.7 0.3  1.00       72       85</span></span>
<span><span class="co">## x[2,7]       -1.0 -0.5 -0.1 -0.5 0.3  0.99       48       69</span></span>
<span><span class="co">## x[1,8]       -0.1  0.3  0.8  0.3 0.3  0.99      139      106</span></span>
<span><span class="co">## x[2,8]       -1.7 -1.2 -0.8 -1.2 0.3  1.01       61       55</span></span>
<span><span class="co">## x[1,9]       -1.2 -0.7 -0.3 -0.8 0.3  0.99       96      128</span></span>
<span><span class="co">## x[2,9]       -2.2 -1.6 -1.0 -1.6 0.4  1.09       27       36</span></span>
<span><span class="co">## x[1,10]      -1.7 -0.9 -0.4 -0.9 0.3  1.01       60      103</span></span>
<span><span class="co">## x[2,10]      -3.1 -2.3 -1.5 -2.3 0.5  1.07       25       15</span></span>
<span><span class="co">## x[1,11]      -2.0 -1.1 -0.7 -1.2 0.4  0.99       82      108</span></span>
<span><span class="co">## x[2,11]      -3.4 -2.6 -1.6 -2.6 0.5  1.05       21       14</span></span>
<span><span class="co">## x[1,12]      -0.6 -0.2  0.3 -0.2 0.2  1.06      107       69</span></span>
<span><span class="co">## x[2,12]      -1.7 -1.2 -0.8 -1.2 0.3  1.03       35       18</span></span>
<span><span class="co">## x[1,13]       0.6  1.1  1.6  1.1 0.3  1.00       64      108</span></span>
<span><span class="co">## x[2,13]      -1.2 -0.6  0.0 -0.6 0.4  1.01       39       37</span></span>
<span><span class="co">## x[1,14]       0.9  1.3  2.2  1.4 0.4  1.02       79       51</span></span>
<span><span class="co">## x[2,14]      -1.5 -0.7 -0.1 -0.8 0.4  1.01       27       16</span></span>
<span><span class="co">## x[1,15]       0.6  1.0  1.4  1.0 0.3  1.01       87       99</span></span>
<span><span class="co">## x[2,15]      -2.4 -1.7 -1.0 -1.7 0.4  1.02       40       85</span></span>
<span><span class="co">## x[1,16]      -1.3 -0.7 -0.2 -0.7 0.3  0.99      133      104</span></span>
<span><span class="co">## x[2,16]      -1.0 -0.7 -0.3 -0.7 0.2  1.01       33       32</span></span>
<span><span class="co">## x[1,17]      -1.2 -0.6 -0.2 -0.7 0.3  1.00       95       58</span></span>
<span><span class="co">## x[2,17]      -0.4  0.0  0.3  0.0 0.3  1.02       37       14</span></span>
<span><span class="co">## x[1,18]      -1.3 -0.7 -0.3 -0.7 0.3  1.00       58       85</span></span>
<span><span class="co">## x[2,18]       0.4  1.0  1.5  1.0 0.4  1.01       48       47</span></span>
<span><span class="co">## x[1,19]      -1.4 -0.7 -0.3 -0.7 0.3  0.99       87       77</span></span>
<span><span class="co">## x[2,19]       1.0  1.6  2.4  1.7 0.4  1.03       44       82</span></span>
<span><span class="co">## x[1,20]      -1.9 -1.2 -0.7 -1.2 0.4  1.01       66      138</span></span>
<span><span class="co">## x[2,20]       1.6  2.4  3.2  2.4 0.6  1.04       28       80</span></span>
<span><span class="co">## Z[1,1]        0.6  0.9  1.3  0.9 0.2  1.02       38       68</span></span>
<span><span class="co">## Z[2,1]       -0.4 -0.1  0.2 -0.1 0.2  0.99       20       12</span></span>
<span><span class="co">## Z[3,1]        0.1  0.3  0.7  0.4 0.2  1.03       36       36</span></span>
<span><span class="co">## Z[4,1]       -1.2 -0.8 -0.6 -0.8 0.2  1.05       58       78</span></span>
<span><span class="co">## Z[1,2]        0.0  0.0  0.0  0.0 0.0  1.00      125      125</span></span>
<span><span class="co">## Z[2,2]        0.5  0.6  0.8  0.7 0.1  1.02       34       26</span></span>
<span><span class="co">## Z[3,2]        0.4  0.6  0.8  0.6 0.1  1.00       57       78</span></span>
<span><span class="co">## Z[4,2]       -0.5 -0.3 -0.2 -0.3 0.1  1.02       85       53</span></span>
<span><span class="co">## log_lik[1]   -1.1 -0.1  0.2 -0.2 0.3  1.00       98       85</span></span>
<span><span class="co">## log_lik[2]   -0.8  1.1  1.4  0.8 0.8  1.00       69      108</span></span>
<span><span class="co">## log_lik[3]   -0.6 -0.1  0.1 -0.2 0.2  1.00       65      102</span></span>
<span><span class="co">## log_lik[4]   -0.7 -0.1  0.2 -0.2 0.3  0.99       93       53</span></span>
<span><span class="co">## log_lik[5]   -1.3  0.0  0.3 -0.2 0.6  1.01       56       83</span></span>
<span><span class="co">## log_lik[6]   -0.3  1.1  1.4  0.9 0.6  1.00       93      103</span></span>
<span><span class="co">## log_lik[7]   -0.5  0.0  0.3  0.0 0.3  0.99      121       86</span></span>
<span><span class="co">## log_lik[8]   -1.0  0.0  0.3 -0.1 0.4  1.00       91      108</span></span>
<span><span class="co">## log_lik[9]   -3.2 -0.8  0.2 -1.0 1.0  1.01      103      140</span></span>
<span><span class="co">## log_lik[10]  -0.5  1.1  1.5  0.9 0.7  1.00       62       76</span></span>
<span><span class="co">## log_lik[11]  -0.4  0.0  0.2  0.0 0.2  1.00      108      134</span></span>
<span><span class="co">## log_lik[12]  -2.1 -0.8  0.1 -0.9 0.8  1.00      102      105</span></span>
<span><span class="co">## log_lik[13]  -1.5 -0.1  0.2 -0.4 0.6  1.01      136      146</span></span>
<span><span class="co">## log_lik[14]  -0.1  1.2  1.5  1.0 0.6  1.01       73      134</span></span>
<span><span class="co">## log_lik[15]  -0.9 -0.2  0.0 -0.3 0.3  1.00      122       83</span></span>
<span><span class="co">## log_lik[16]  -3.2 -1.1  0.0 -1.3 1.1  1.01      218      133</span></span>
<span><span class="co">## log_lik[17]  -3.7 -0.9  0.1 -1.2 1.1  1.00      155      108</span></span>
<span><span class="co">## log_lik[18]  -0.9  1.1  1.4  0.8 0.7  1.00      110       51</span></span>
<span><span class="co">## log_lik[19]  -1.5 -0.3  0.1 -0.4 0.5  0.99      145      138</span></span>
<span><span class="co">## log_lik[20]  -0.6 -0.1  0.1 -0.2 0.2  1.00      116      143</span></span>
<span><span class="co">## log_lik[21]  -2.7 -0.6  0.3 -0.8 1.0  1.00       84      144</span></span>
<span><span class="co">## log_lik[22]  -0.7  1.1  1.5  0.8 0.7  1.00      120      146</span></span>
<span><span class="co">## log_lik[23]  -1.1 -0.1  0.1 -0.2 0.4  1.03       59      103</span></span>
<span><span class="co">## log_lik[24]  -0.7 -0.1  0.1 -0.2 0.3  0.99      113      134</span></span>
<span><span class="co">## log_lik[25]  -0.8 -0.1  0.2 -0.2 0.4  1.01      127      106</span></span>
<span><span class="co">## log_lik[26]  -1.1  1.0  1.4  0.7 0.9  0.99      125      108</span></span>
<span><span class="co">## log_lik[27]  -0.4 -0.1  0.1 -0.1 0.1  1.03      118      130</span></span>
<span><span class="co">## log_lik[28]  -0.5 -0.1  0.2 -0.1 0.2  1.00       80      104</span></span>
<span><span class="co">## log_lik[29]  -0.8 -0.1  0.2 -0.2 0.4  1.00      119       99</span></span>
<span><span class="co">## log_lik[30]  -0.4  1.1  1.5  0.8 0.6  1.00      102       83</span></span>
<span><span class="co">## log_lik[31]  -1.1 -0.1  0.3 -0.2 0.4  1.00      146       98</span></span>
<span><span class="co">## log_lik[32]  -1.1 -0.2  0.1 -0.3 0.4  1.01      125      106</span></span>
<span><span class="co">## log_lik[33]  -2.9 -0.9  0.0 -1.1 0.9  0.99      114      143</span></span>
<span><span class="co">## log_lik[34]  -0.3  1.1  1.5  0.9 0.7  1.05       40      138</span></span>
<span><span class="co">## log_lik[35]  -0.3  0.1  0.3  0.1 0.2  1.11       61      106</span></span>
<span><span class="co">## log_lik[36]  -1.3 -0.1  0.2 -0.3 0.5  0.99      162       99</span></span>
<span><span class="co">## log_lik[37]  -1.8 -0.3  0.1 -0.5 0.7  0.99      123      146</span></span>
<span><span class="co">## log_lik[38]  -0.2  1.2  1.5  1.0 0.7  1.00       99      130</span></span>
<span><span class="co">## log_lik[39]  -0.7 -0.1  0.2 -0.1 0.3  1.00       51       83</span></span>
<span><span class="co">## log_lik[40]  -1.5 -0.1  0.3 -0.4 0.6  0.99       75      108</span></span>
<span><span class="co">## log_lik[41]  -1.7 -0.2  0.2 -0.4 0.7  1.05      115      143</span></span>
<span><span class="co">## log_lik[42]  -0.7  1.1  1.5  0.8 0.7  0.99      126       83</span></span>
<span><span class="co">## log_lik[43]  -0.6 -0.1  0.1 -0.2 0.2  1.02       49      101</span></span>
<span><span class="co">## log_lik[44]  -2.1 -0.1  0.3 -0.5 0.9  1.00       79       83</span></span>
<span><span class="co">## log_lik[45]  -1.8 -0.4  0.1 -0.6 0.7  1.06      136       93</span></span>
<span><span class="co">## log_lik[46]  -0.7  1.1  1.5  0.8 0.8  0.99      112       71</span></span>
<span><span class="co">## log_lik[47]  -2.9 -1.3 -0.3 -1.4 0.8  1.04       95      137</span></span>
<span><span class="co">## log_lik[48]  -0.7 -0.1  0.2 -0.1 0.3  0.99       96      101</span></span>
<span><span class="co">## log_lik[49]  -1.4 -0.2  0.2 -0.3 0.5  1.01      109      103</span></span>
<span><span class="co">## log_lik[50]  -0.3  1.0  1.4  0.8 0.6  1.00       71      108</span></span>
<span><span class="co">## log_lik[51]  -1.0 -0.1  0.2 -0.2 0.4  1.01       86      134</span></span>
<span><span class="co">## log_lik[52]  -0.9 -0.1  0.1 -0.2 0.4  1.03      119      138</span></span>
<span><span class="co">## log_lik[53]  -2.5 -0.6  0.1 -0.8 0.9  1.00      109      101</span></span>
<span><span class="co">## log_lik[54]  -0.2  1.1  1.5  0.9 0.6  1.08       57      103</span></span>
<span><span class="co">## log_lik[55]  -0.5 -0.1  0.1 -0.1 0.2  1.04       41       99</span></span>
<span><span class="co">## log_lik[56]  -0.9 -0.1  0.2 -0.2 0.4  0.99       62       81</span></span>
<span><span class="co">## log_lik[57]  -1.1  0.0  0.4 -0.1 0.4  1.02       67      106</span></span>
<span><span class="co">## log_lik[58]  -0.5  1.0  1.4  0.8 0.8  1.00      109      134</span></span>
<span><span class="co">## log_lik[59]  -0.7 -0.1  0.2 -0.1 0.3  0.99      142       85</span></span>
<span><span class="co">## log_lik[60]  -0.5  0.1  0.3  0.0 0.3  1.00       82      143</span></span>
<span><span class="co">## log_lik[61]  -8.2 -3.5 -0.6 -3.7 2.2  1.00      162      108</span></span>
<span><span class="co">## log_lik[62]  -0.8  1.1  1.5  0.8 0.9  1.01       97      146</span></span>
<span><span class="co">## log_lik[63]  -1.6 -0.7 -0.1 -0.7 0.5  1.03       77       85</span></span>
<span><span class="co">## log_lik[64]  -3.2 -1.0  0.0 -1.2 1.2  1.00      131      146</span></span>
<span><span class="co">## log_lik[65]  -0.9  0.0  0.3 -0.1 0.4  1.00       56      108</span></span>
<span><span class="co">## log_lik[66]  -0.1  1.1  1.5  1.0 0.5  1.01       78      128</span></span>
<span><span class="co">## log_lik[67]  -0.4  0.0  0.2  0.0 0.2  1.03       36      146</span></span>
<span><span class="co">## log_lik[68]  -0.8 -0.1  0.1 -0.2 0.3  1.00       51      104</span></span>
<span><span class="co">## log_lik[69]  -1.4 -0.2  0.2 -0.3 0.5  1.09      147       19</span></span>
<span><span class="co">## log_lik[70]  -0.3  1.2  1.4  0.9 0.6  1.09       10       81</span></span>
<span><span class="co">## log_lik[71]  -0.6 -0.1  0.2 -0.2 0.2  1.00      102      146</span></span>
<span><span class="co">## log_lik[72]  -0.8  0.0  0.2 -0.1 0.4  1.00      151      137</span></span>
<span><span class="co">## log_lik[73]  -0.7  0.0  0.2 -0.1 0.4  1.02       58      106</span></span>
<span><span class="co">## log_lik[74]  -0.6  1.1  1.4  0.8 0.8  1.05       23       21</span></span>
<span><span class="co">## log_lik[75]  -0.4 -0.1  0.2 -0.1 0.2  1.04       53      106</span></span>
<span><span class="co">## log_lik[76]  -0.8  0.1  0.3  0.0 0.4  1.09       77       39</span></span>
<span><span class="co">## log_lik[77]  -1.4 -0.1  0.2 -0.3 0.5  1.01      130       29</span></span>
<span><span class="co">## log_lik[78]  -0.2  1.1  1.4  0.9 0.6  1.00       65      101</span></span>
<span><span class="co">## log_lik[79]  -0.6 -0.1  0.1 -0.2 0.2  1.02       69       81</span></span>
<span><span class="co">## log_lik[80]  -1.5 -0.1  0.2 -0.3 0.6  1.00      115      104</span></span>
<span><span class="co">## xstar[1,1]   -2.9 -1.1  0.3 -1.1 1.0  0.99      131      106</span></span>
<span><span class="co">## xstar[2,1]    0.6  2.3  4.1  2.3 1.0  1.00       96      100</span></span>
<span><span class="co">## sigma[1]      0.4  0.5  0.6  0.5 0.1  1.03       52       86</span></span>
<span><span class="co">## lp__        -12.0  1.8 13.9  1.5 8.1  1.08       17       24</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## For each parameter, Bulk_ESS and Tail_ESS are crude measures of </span></span>
<span><span class="co">## effective sample size for bulk and tail quantities respectively (an ESS &gt; 100 </span></span>
<span><span class="co">## per chain is considered good), and Rhat is the potential scale reduction </span></span>
<span><span class="co">## factor on rank normalized split chains (at convergence, Rhat &lt;= 1.05).</span></span></code></pre>
<p>As a second type of weighting, we also have implemented weights in
the same form used in other widely used packages (glmmTMB, sdmTMB, brms,
etc). In this case, weights are used as multipliers on the
log-likelihood of each observation. To specify these kinds of weights,
we use the <code>likelihood_weights</code> argument instead, where
observations with higher weights contribute more to the total log
likelihood.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">df</span>, num_trends <span class="op">=</span> <span class="fl">2</span>, scale<span class="op">=</span><span class="st">"zscore"</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">500</span>, chains <span class="op">=</span> <span class="fl">1</span>, thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  likelihood_weights <span class="op">=</span> <span class="st">"weights"</span>, data_shape <span class="op">=</span> <span class="st">"long"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Eric J. Ward, Sean C. Anderson, Luis A. Damiano, Michael J. Malick.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
